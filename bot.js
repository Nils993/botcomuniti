const TelegramBot = require("node-telegram-bot-api");

// –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
const TOKEN = "7093156278:AAFP49PyEr3FGgZr1tw6QEXX0rQYeiWVpHQ";

// –°–æ–∑–¥–∞–π—Ç–µ —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
const bot = new TelegramBot(TOKEN, { polling: true });

// –ü—Ä–∞–≤–∏–ª–∞ –≥—Ä—É–ø–ø—ã
const RULES_TEXT = `
–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ß–ê–¢ –û–ë–©–ò–ù–´, {first_name}!

‚ùóÔ∏è‚ùóÔ∏è‚ùóÔ∏è–í–ù–ò–ú–ê–ù–ò–ï
üí™üí™üí™–ù–∞—à —á–∞—Ç —Å–æ–∑–¥–∞–Ω –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â–∏ —Ä—É—Å—Å–∫–∏—Ö –ª—é–¥–µ–π.

‚õîÔ∏è –ü–æ—ç—Ç–æ–º—É —Ç–∞–º –∑–∞–ø—Ä–µ—â–µ–Ω—ã:
- —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Ä–µ–ø–æ—Å—Ç–æ–≤ –∏–∑ –¥—Ä—É–≥–∏—Ö –∫–∞–Ω–∞–ª–æ–≤; —Ä–µ–ø–æ—Å—Ç –≤–æ–∑–º–æ–∂–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, —á—Ç–æ –≤—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —Å–¥–µ–ª–∞—Ç—å –ø–æ —ç—Ç–æ–º—É –ø–æ–≤–æ–¥—É –∏ –∫–∞–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤ —ç—Ç–æ–º –ø—Ä–æ—Å–∏—Ç–µ;
- –ø—É—Å—Ç—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã —Å–æ —Å–≤–æ–∏–º –º–Ω–µ–Ω–∏–µ–º –ø–æ —Å–∏—Ç—É–∞—Ü–∏–∏; –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, —á—Ç–æ –≤—ã –≥–æ—Ç–æ–≤—ã —Å–¥–µ–ª–∞—Ç—å –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã, —Ç–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≤–∞–º–∏ –≤–∞—à–µ–≥–æ –º–Ω–µ–Ω–∏—è –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è —Å–ø–∞–º–æ–º –∏ —É–¥–∞–ª—è—Ç—å—Å—è –≤–º–µ—Å—Ç–µ —Å –∞–≤—Ç–æ—Ä–æ–º;
- –æ–±—Å—É–∂–¥–µ–Ω–∏—è –æ —Ç–æ–º, –∫–∞–∫–∏–µ –ø–ª–æ—Ö–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–∏ —Ç–µ—Ö –∏–ª–∏ –∏–Ω—ã—Ö –Ω–∞—Ä–æ–¥–æ–≤ ‚Äì –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∞–Ω –∞–≤—Ç–æ—Ä–∞–º;
- —Å–ø–æ—Ä—ã –Ω–∞ –ª—é–±—ã–µ —Ä–µ–ª–∏–≥–∏–æ–∑–Ω—ã–µ —Ç–µ–º—ã (—á—å—è –≤–µ—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ –∏–ª–∏ –ª—É—á—à–µ) ‚Äì –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–∞–Ω –∞–≤—Ç–æ—Ä–∞–º;
- —Å–ø–æ—Ä—ã –æ —Ç–æ–º, –∫–∞–∫–æ–π –ø–µ—Ä–∏–æ–¥ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –†–æ—Å—Å–∏–∏ –±—ã–ª –ª—É—á—à–µ –∏–ª–∏ —Ö—É–∂–µ —Å –æ–±—Å—É–∂–¥–µ–Ω–∏–µ–º –∏ –∫—Ä–∏—Ç–∏–∫–æ–π –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π ‚Äì –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∞–Ω;
- –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–µ—Ç–æ—É–±–∏–π—Å—Ç–≤ (–∞–±–æ—Ä—Ç–æ–≤) ‚Äì –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∞–Ω;
- —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã;
- –ª—é–±—ã–µ –ø—Ä–∏–∑—ã–≤—ã –∫ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–º –¥–µ–π—Å—Ç–≤–∏—è–º, –º–∏—Ç–∏–Ω–≥–∞–º, –ø–∏–∫–µ—Ç–∞–º, —É–ª–∏—á–Ω—ã–º –∞–∫—Ü–∏—è–º –ø—Ä–æ—Ç–µ—Å—Ç–∞, —Ä–µ–∫–ª–∞–º–∞ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä—Ç–∏–π ‚Äì –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∞–Ω;
- —Å–ø–æ—Ä—ã –æ —Ç–æ–º, –∫–∞–∫–∞—è –Ω–∞—Ü–∏—è –ª—É—á—à–µ –∏ –æ —Ç–æ–º, –∫—Ç–æ –∏—Å—Ç–∏–Ω–Ω–æ —Å–ª–∞–≤—è–Ω–∏–Ω –∏–ª–∏ —Ä—É—Å—Å–∫–∏–π, –∞ –∫—Ç–æ ‚Äì –Ω–µ—Ç; –∞–≤—Ç–æ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ –±–∞–Ω;
- –º–∞—Ç–µ—Ä—â–∏–Ω–∞ –∏ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞;
- –ø—Ä–∏–∑—ã–≤—ã –∫ –Ω–∞—Å–∏–ª—å—Å—Ç–≤–µ–Ω–Ω—ã–º –¥–µ–π—Å—Ç–≤–∏—è–º –ª—é–±–æ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞.

–†—É—Å—Å–∫–∞—è –æ–±—â–∏–Ω–∞ –∏–º–µ–µ—Ç –¥–≤–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ —Å–≤–æ–µ–π —Ä–∞–±–æ—Ç–µ:
- –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â–∏
- –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ —Ç—Ä–∞–¥–∏—Ü–∏–π –∏ –≤–æ–∑–≤—Ä–∞—Ç –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –∫–æ–¥–∞ —Ä—É—Å—Å–∫–æ–º—É —á–µ–ª–æ–≤–µ–∫—É

‚ö°Ô∏è‚ö°Ô∏è‚ö°Ô∏è–ú—ã –Ω–µ –ø—Ä–æ—Ç–∏–≤ –¥—Ä—É–≥–∏—Ö –Ω–∞—Ä–æ–¥–æ–≤ –∏–ª–∏ –º–∏–≥—Ä–∞–Ω—Ç–æ–≤, –º—ã –∑–∞ –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞—Ä–æ–¥–∞ –Ω–µ –≤ —É—â–µ—Ä–± –¥—Ä—É–≥–∏–º –Ω–∞—Ä–æ–¥–∞–º.
–ü—Ä–æ—Å–∏–º –≤—Å–µ—Ö –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—á–µ—Å—Ç—å —ç—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –Ω–∞—à–∏–º —á–∞—Ç–æ–º –¥–ª—è –æ–±—â–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è –†—É—Å—Å–∫–æ–≥–æ –º–∏—Ä–∞.

‚ùó‚ùóÔ∏è‚ùóÔ∏è‚ùóÔ∏è‚ùóÔ∏è
–ù–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –≤ —á–∞—Ç–µ –†–û –µ—â—ë –Ω–µ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤—ã —è–≤–ª—è–µ—Ç–µ—Å—å —á–ª–µ–Ω–æ–º –û–±—â–∏–Ω—ã.
–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ–º –≤ –û–±—â–∏–Ω—É —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ–¥–æ–±—Ä–µ–Ω–∏–µ –≤–∞—à–µ–π –∫–∞–Ω–¥–∏–¥–∞—Ç—É—Ä—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–æ–º!
`;

// –ö–Ω–æ–ø–∫–∞ "–û–∑–Ω–∞–∫–æ–º–ª–µ–Ω"
const BUTTON_TEXT = "–û–∑–Ω–∞–∫–æ–º–ª–µ–Ω";

bot.on("message", (msg) => {
  const chatId = msg.chat.id;

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
  if (msg.new_chat_members) {
    msg.new_chat_members.forEach((member) => {
      const firstName = member.first_name;
      const messageText = RULES_TEXT.replace("{first_name}", firstName);

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∏ –∫–Ω–æ–ø–∫–æ–π
      bot
        .sendMessage(chatId, messageText, {
          reply_markup: {
            inline_keyboard: [
              [
                {
                  text: BUTTON_TEXT,
                  callback_data: `acknowledged_${member.id}`,
                },
              ],
            ],
          },
        })
        .then((sentMessage) => {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
          bot.on("callback_query", (query) => {
            const callbackData = query.data;
            const userId = query.from.id;
            const username = query.from.first_name;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞ —Ç–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –∫–æ—Ç–æ—Ä–æ–º—É –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (
              callbackData === `acknowledged_${member.id}` &&
              userId === member.id
            ) {
              bot.deleteMessage(chatId, sentMessage.message_id);
              bot.answerCallbackQuery(query.id, {
                text: "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏–µ!",
              });
              bot.sendMessage(
                chatId,
                `${username}, –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –æ—Ç–∫—Ä—ã—Ç—ã–π —á–∞—Ç –†—É—Å—Å–∫–æ–π –û–±—â–∏–Ω—ã –¢–æ–±–æ–ª—å—Å–∫–∞`
              );
            } else {
              // –£–≤–µ–¥–æ–º–ª—è–µ–º, –¥–ª—è –∫–æ–≥–æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞
              const messageText = `–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${member.first_name}.`;
              bot.answerCallbackQuery(query.id, { text: messageText });
            }
          });
        });
    });
  }
});
